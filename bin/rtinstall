#!/usr/bin/env bash
OPENSIM_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
REGIONS_DIR="${OPENSIM_DIR}/etc/sims-enabled"
TARGET_DIR="runtime"

if [ $# -eq 0 ]; then
    echo "Usage: $0 [-c] <opensim_distribution.zip>"
    echo "-c: Perform clean install and clear scriptcache"
    echo "Multiple zips at once can be specified, for instance any addons"
    exit 0
fi

if [ ! -x `which unzip` ]; then
    echo "Package 'unzip' needs to be installed"
    exit 0
fi

mkdir -p "${OPENSIM_DIR}/var/log"

do_log() {
    touch "${OPENSIM_DIR}/var/log/isthmus.log"
    logline="`date --iso-8601=seconds` - rtinstall - $1"
    echo "${logline}" >> "${OPENSIM_DIR}/var/log/isthmus.log"
}

do_install() {
    # Preserve custom *.config for log4net, also exclude unneeded stuff:
    EXCLUDE="bin/config-include/* bin/Regions/* bin/Estates/* bin/OpenSim.ini bin/OpenSim.exe.config bin/Robust.exe.config bin/MoneyServer.exe.config bin/MoneyServer.dll.config"
    cd "${OPENSIM_DIR}"
    # If we upgrade to a runtime that doesn't have a .version,
    # we don't want the wrong/old version to be displayed inworld:
    rm -f "bin/.version"
    unzip -q -o -d "${TARGET_DIR}" "${ZIP_FILE}" -x ${EXCLUDE} &>/dev/null
    echo "Installed ${ZIP_FILE}"
    do_log "rtinstall: Installed ${ZIP_FILE}"
}

is_running() {
    SIM=$1

    SCREENPID=`screen -ls ${SIM} | grep -P "${SIM}\t" | cut -f1 -d'.' | sed 's/W//g'`
    if [ -n "${SCREENPID}" ]; then
        return 0
    else
        return 1
    fi
}

is_robust_running()
{
    SCREENNAME="`basename ${OPENSIM_DIR}`-ROBUST"
    SCREENPID=`screen -ls ${SCREENNAME} | grep -P "${SCREENNAME}\t" | cut -f1 -d'.' | sed 's/W//g'`
    if [ -n "${SCREENPID}" ]; then
        return 0
    else
        return 1
    fi
}

any_sims_online() {
    for simulator in ${REGIONS_DIR}/*; do
        simname=`basename ${simulator} .ini`
        if is_running ${simname}; then
            return 0
        fi
    done;
    return 1
}

if any_sims_online; then
    echo "All sims need to be stopped first."
    exit 1
fi
if is_running ROBUST; then
    echo "ROBUST must be stopped first."
    exit 1
fi

if [ "$1" == "-c" ]; then
    if [ $# -eq 1 ]; then
        echo "No zipfile(s) specified"
        exit 1
    fi
    CLEAN_INSTALL="true"
    if [ -x "simtool" ]; then
        echo "Clearing scriptcache, while preserving state"
        ./simtool clearscripts
    fi
    OLD_VERSION="unknown version"
    if [ -r "${OPENSIM_DIR}/runtime/bin/.version" ]; then
        OLD_VERSION=`cat ${OPENSIM_DIR}/runtime/bin/.version`
    fi
    if [ -d "${OPENSIM_DIR}/runtime/bin" ]; then
        echo "Removing old runtime (${OLD_VERSION})..."
        rm -R "${OPENSIM_DIR}/runtime/bin"
    fi
    # Strip first parameter -c from parameter list:
    shift
fi

# Iterate over the parameter list, they are all assumed to be zips:
for arg in $@
do
    ZIP_FILE=`readlink -f "$arg"`
    if [ ! -r "${ZIP_FILE}" ]; then
        echo "Zipfile '${ZIP_FILE}' does not exist, skipping"
    else
        do_install
    fi
done

# Restore *.config for log4net after a clean install:
if [ "$CLEAN_INSTALL" == "true" ]; then
    echo "Configuring runtime for isthmus..."
    cp -r "${OPENSIM_DIR}/share/common/runtime/bin/." "${OPENSIM_DIR}/runtime/bin"
fi

